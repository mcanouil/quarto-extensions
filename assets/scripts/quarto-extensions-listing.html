<!-- Custom JavaScript for enhanced functionality -->
<script id="quarto-extensions-listing" type="text/javascript">
document.addEventListener('DOMContentLoaded', function() {
  // Store original order for reset functionality
  let originalListOrder = [];
  let originalGridOrder = [];
  
  // Store original order on page load
  const initialListContainer = document.querySelector('#list-view-container .list-group');
  const initialGridContainer = document.querySelector('#grid-view-container .grid');
  
  if (initialListContainer) {
    originalListOrder = Array.from(initialListContainer.querySelectorAll('.list-group-item'));
  }
  
  if (initialGridContainer) {
    originalGridOrder = Array.from(initialGridContainer.querySelectorAll('.g-col-sm-6, .g-col-lg-4'));
  }
  
  // Function definitions (moved up for early initialization)
  function sortExtensions(field, direction) {
    const listContainer = document.querySelector('#list-view-container .list-group');
    const gridContainer = document.querySelector('#grid-view-container .grid');
    
    // Sort list view
    if (listContainer) {
      const listItems = Array.from(listContainer.querySelectorAll('.list-group-item'));
      sortItems(listItems, field, direction);
      listItems.forEach(item => listContainer.appendChild(item));
    }
    
    // Sort grid view
    if (gridContainer) {
      const gridItems = Array.from(gridContainer.querySelectorAll('.g-col-sm-6, .g-col-lg-4'));
      sortItems(gridItems, field, direction);
      gridItems.forEach(item => gridContainer.appendChild(item));
    }
  }
  
  function sortItems(items, field, direction) {
    items.sort((a, b) => {
      // For list view, the data is on the .list-group-item itself (which has .extension-item class)
      // For grid view, the data is on the .extension-card inside the .g-col-* container
      const extA = a.classList.contains('list-group-item') ? a : a.querySelector('.extension-card');
      const extB = b.classList.contains('list-group-item') ? b : b.querySelector('.extension-card');
      
      let valueA, valueB;
      
      if (field === 'modified') {
        valueA = new Date(extA.dataset.modified || 0);
        valueB = new Date(extB.dataset.modified || 0);
      } else if (field === 'stars') {
        valueA = parseInt(extA.dataset.stars || 0);
        valueB = parseInt(extB.dataset.stars || 0);
      }
      
      if (direction === 'desc') {
        return valueB - valueA;
      } else {
        return valueA - valueB;
      }
    });
  }
  
  // Apply default sorting (Recently Updated - most recent first)
  const defaultSortField = 'modified';
  const defaultSortDirection = 'desc';
  sortExtensions(defaultSortField, defaultSortDirection);
  
  // Update the Recently Updated chip to show it's active with down arrow
  const recentChip = document.querySelector('.filter-chip[data-filter="recent"]');
  if (recentChip) {
    const icon = document.createElement('i');
    icon.className = 'sort-icon ms-1 bi bi-arrow-down';
    recentChip.appendChild(icon);
  }
  
  // Initialize sort state
  let sortState = { field: defaultSortField, direction: defaultSortDirection };
  
  // View toggle functionality
  const listViewBtn = document.getElementById('list-view');
  const gridViewBtn = document.getElementById('grid-view');
  const listContainer = document.getElementById('list-view-container');
  const gridContainer = document.getElementById('grid-view-container');
  
  listViewBtn.addEventListener('change', function() {
    if (this.checked) {
      listContainer.classList.remove('d-none');
      gridContainer.classList.add('d-none');
    }
  });
  
  gridViewBtn.addEventListener('change', function() {
    if (this.checked) {
      gridContainer.classList.remove('d-none');
      listContainer.classList.add('d-none');
    }
  });
  
  // Search functionality
  const searchInput = document.getElementById('extension-search');
  searchInput.addEventListener('input', debounce(performSearch, 300));
  
  function performSearch() {
    const query = searchInput.value.toLowerCase();
    const extensions = document.querySelectorAll('.extension-item, .extension-card');
    
    extensions.forEach(ext => {
      const title = ext.querySelector('.extension-title, .card-title').textContent.toLowerCase();
      const description = ext.querySelector('.extension-description, .card-text').textContent.toLowerCase();
      const author = ext.dataset.author.toLowerCase();
      const categories = ext.dataset.categories.toLowerCase();
      const contributes = ext.dataset.contributes.toLowerCase();

      const matches = title.includes(query) || 
                     description.includes(query) || 
                     author.includes(query) || 
                     categories.includes(query) || 
                     contributes.includes(query);
      
      ext.closest('.list-group-item, .g-col-sm-6, .g-col-lg-4').style.display = matches ? '' : 'none';
    });
  }
  
  // Filter chip functionality
  const filterChips = document.querySelectorAll('.filter-chip');
  let activeFilters = new Set();
  let activeAuthorLogin = null;

  filterChips.forEach(chip => {
    chip.addEventListener('click', function() {
      const filter = this.dataset.filter;
      // Author filter logic
      if (filter === 'author' && this.dataset.login) {
        // Remove active state from all author filter chips
        document.querySelectorAll('.filter-chip[data-filter="author"][data-login]').forEach(btn => {
          btn.classList.remove('active');
        });
        // Set active state for clicked chip
        this.classList.add('active');
        activeAuthorLogin = this.dataset.login;
        applyFilters();
        return;
      }
      // Handle sorting for Recently Updated and Popular
      if (filter === 'recent') {
        handleSorting('modified', this);
        return;
      } else if (filter === 'popular') {
        handleSorting('stars', this);
        return;
      }
      // Handle regular filters
      if (this.classList.contains('active')) {
        this.classList.remove('active');
        activeFilters.delete(filter);
      } else {
        this.classList.add('active');
        activeFilters.add(filter);
      }
      applyFilters();
    });
  });

  // Clear filters
  document.getElementById('clear-filters').addEventListener('click', function() {
    filterChips.forEach(chip => {
      chip.classList.remove('active');
      // Remove sort icons
      const icon = chip.querySelector('.sort-icon');
      if (icon) icon.remove();
    });
    activeFilters.clear();
    activeAuthorLogin = null;
    sortState = { field: null, direction: 'desc' };
    applyFilters();
    resetSort();
  });

  function handleSorting(field, chip) {
    // Toggle sort direction if same field, otherwise set to descending
    if (sortState.field === field) {
      sortState.direction = sortState.direction === 'desc' ? 'asc' : 'desc';
    } else {
      sortState.field = field;
      sortState.direction = 'desc';
    }
    
    // Update visual indicators
    updateSortIcons(chip, sortState.direction);
    
    // Apply sorting
    sortExtensions(field, sortState.direction);
  }
  
  function updateSortIcons(activeChip, direction) {
    // Remove all existing sort icons
    filterChips.forEach(chip => {
      const existingIcon = chip.querySelector('.sort-icon');
      if (existingIcon) existingIcon.remove();
    });
    
    // Add icon to active chip
    const icon = document.createElement('i');
    icon.className = `sort-icon ms-1 bi bi-arrow-${direction === 'desc' ? 'down' : 'up'}`;
    activeChip.appendChild(icon);
  }
  
  function resetSort() {
    // Reset to original order using stored arrays
    const listContainer = document.querySelector('#list-view-container .list-group');
    const gridContainer = document.querySelector('#grid-view-container .grid');
    
    if (listContainer && originalListOrder.length > 0) {
      originalListOrder.forEach(item => listContainer.appendChild(item));
    }
    
    if (gridContainer && originalGridOrder.length > 0) {
      originalGridOrder.forEach(item => gridContainer.appendChild(item));
    }
  }
  
  function applyFilters() {
    const extensions = document.querySelectorAll('.extension-item, .extension-card');
    const filterChipValues = [
      'shortcode',
      'filter',
      'format',
      'project',
      'revealjs-plugins',
      'metadata'
    ];
    extensions.forEach(ext => {
      let show = true;
      // Author filter
      if (activeAuthorLogin) {
        const extLogin = ext.getAttribute('data-login');
        if (extLogin !== activeAuthorLogin) {
          show = false;
        }
      }
      // Template filter
      if (activeFilters.has('template') && ext.dataset.template !== 'true') {
        show = false;
      }
      // Generalised category filters
      filterChipValues.forEach(function(filter) {
        if (activeFilters.has(filter)) {
          // For 'revealjs-plugins' and 'metadata', check for exact match in categories
          if (filter === 'revealjs-plugins' || filter === 'metadata') {
            if (!ext.dataset.categories.toLowerCase().split(',').map(c => c.trim()).includes(filter)) {
              show = false;
            }
          } else {
            if (!ext.dataset.categories.toLowerCase().includes(filter)) {
              show = false;
            }
          }
        }
      });
      ext.closest('.list-group-item, .g-col-sm-6, .g-col-lg-4').style.display = show ? '' : 'none';
    });
  }
  
  // Utility function for debouncing
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }
  
  // Category expansion for list view
  document.querySelectorAll('.category-expand-toggle').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      const targetId = btn.getAttribute('data-id');
      const target = document.getElementById(targetId);
      if (target) {
        target.classList.remove('d-none');
        btn.classList.add('category-expanded');
        btn.style.display = 'none'; // Hide button when expanded
      }
    });
  });

  // Collapse expanded categories when clicking elsewhere
  document.addEventListener('click', function(e) {
    document.querySelectorAll('.category-expand-toggle.category-expanded').forEach(function(btn) {
      const targetId = btn.getAttribute('data-id');
      const target = document.getElementById(targetId);
      if (target && !btn.contains(e.target) && !target.contains(e.target)) {
        target.classList.add('d-none');
        btn.classList.remove('category-expanded');
        btn.style.display = ''; // Show button when collapsed
      }
    });
  });
});
</script>
