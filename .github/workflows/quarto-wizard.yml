name: Quarto Wizard

on:
  workflow_dispatch:
    inputs:
      debug:
        description: "Enable debug mode"
        required: false
        default: false
        type: boolean
      force_update:
        description: "Force update all extensions"
        required: false
        default: false
        type: boolean
  repository_dispatch:
  release:
    types: [published]
  push:
    branches:
      - main
    paths:
      - extensions/quarto-extensions.csv
  schedule:
    - cron: "0 6 * * *"

permissions:
  contents: write
  pull-requests: write

jobs:
  get-extensions:
    runs-on: ubuntu-latest
    outputs:
      updated-count: ${{ steps.get-extensions-details.outputs.updated-count }}
      skipped-count: ${{ steps.get-extensions-details.outputs.skipped-count }}
      outdated-count: ${{ steps.get-extensions-details.outputs.outdated-count }}
      renamed-count: ${{ steps.get-extensions-details.outputs.renamed-count }}
      updated-extensions: ${{ steps.get-extensions-details.outputs.updated-extensions }}
      skipped-extensions: ${{ steps.get-extensions-details.outputs.skipped-extensions }}
      outdated-extensions: ${{ steps.get-extensions-details.outputs.outdated-extensions }}
      renamed-extensions: ${{ steps.get-extensions-details.outputs.renamed-extensions }}
    env:
      BRANCH: quarto-wizard
      COMMIT: "ci: update extensions details"
      CSV_FILE: "extensions/quarto-extensions.csv"
      JSON_FILE: "quarto-extensions.json"
      EXTENSIONS_DIR: "extensions"
      DEBUG_MODE: ${{ github.event.inputs.debug }}
      FORCE_UPDATE: ${{ github.event.inputs.force_update }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ env.BRANCH }}

      - name: Checkout repository with sparse checkout
        uses: actions/checkout@v6
        with:
          sparse-checkout: ${{ env.CSV_FILE }}
          sparse-checkout-cone-mode: false
          path: data

      - name: Create GitHub App token
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_KEY }}

      - name: Get GitHub App User ID
        id: get-user-id
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          APP_SLUG: ${{ steps.app-token.outputs.app-slug }}
        shell: bash
        run: echo "user-id=$(gh api "/users/${APP_SLUG}[bot]" --jq .id)" >> "${GITHUB_OUTPUT}"

      - name: Git Config
        env:
          APP_SLUG: ${{ steps.app-token.outputs.app-slug }}
          USER_ID: ${{ steps.get-user-id.outputs.user-id }}
        shell: bash
        run: |
          git config --global user.name "${APP_SLUG}[bot]"
          git config --global user.email "${USER_ID}+${APP_SLUG}[bot]@users.noreply.github.com"

      - name: Branch Setup
        if: false
        shell: bash
        run: |
          git fetch --all
          if git show-ref --verify --quiet refs/heads/"${BRANCH}"; then
            echo "Branch exists"
          else
            echo "Branch does not exist"
            git checkout --orphan "${BRANCH}"
            git rm -rf .
            git commit --allow-empty -m "ci: setup ${BRANCH} branch"
            git push --force origin "${BRANCH}"
          fi
          git checkout "${BRANCH}"

      - name: Checkout scripts from main branch
        uses: actions/checkout@v6
        with:
          ref: main
          sparse-checkout: .github/scripts
          sparse-checkout-cone-mode: false
          path: scripts-checkout

      - name: Copy scripts to working directory
        shell: bash
        run: |
          mkdir -p .github/scripts
          cp -r scripts-checkout/.github/scripts/* .github/scripts/
          rm -rf scripts-checkout

      - name: Get extensions details
        id: get-extensions-details
        shell: bash
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          DEBUG_MODE: ${{ env.DEBUG_MODE }}
          FORCE_UPDATE: ${{ env.FORCE_UPDATE }}
          EXTENSIONS_DIR: ${{ env.EXTENSIONS_DIR }}
          JSON_FILE: ${{ env.JSON_FILE }}
          BRANCH: ${{ env.BRANCH }}
          COMMIT: ${{ env.COMMIT }}
          CSV_FILE: ${{ env.CSV_FILE }}
        run: .github/scripts/quarto-wizard/main.sh

  summary:
    runs-on: ubuntu-latest
    needs:
      - get-extensions
    if: always()
    env:
      BRANCH: quarto-wizard
      UPDATED_COUNT: ${{ needs.get-extensions.outputs.updated-count }}
      SKIPPED_COUNT: ${{ needs.get-extensions.outputs.skipped-count }}
      OUTDATED_COUNT: ${{ needs.get-extensions.outputs.outdated-count }}
      RENAMED_COUNT: ${{ needs.get-extensions.outputs.renamed-count }}
      UPDATED_EXTENSIONS: ${{ needs.get-extensions.outputs.updated-extensions }}
      SKIPPED_EXTENSIONS: ${{ needs.get-extensions.outputs.skipped-extensions }}
      OUTDATED_EXTENSIONS: ${{ needs.get-extensions.outputs.outdated-extensions }}
      RENAMED_EXTENSIONS: ${{ needs.get-extensions.outputs.renamed-extensions }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ env.BRANCH }}

      - name: Generate workflow summary
        env:
          DEBUG_MODE: ${{ github.event.inputs.debug }}
        shell: bash
        run: |
          UPDATED_COUNT=${UPDATED_COUNT:-0}
          SKIPPED_COUNT=${SKIPPED_COUNT:-0}
          OUTDATED_COUNT=${OUTDATED_COUNT:-0}
          RENAMED_COUNT=${RENAMED_COUNT:-0}

          if [[ "${DEBUG_MODE}" == "true" ]]; then
            echo "## Extension Processing Summary (Debug Mode)" >> "${GITHUB_STEP_SUMMARY}"
          else
            echo "## Extension Processing Summary" >> "${GITHUB_STEP_SUMMARY}"
          fi

          echo "" >> "${GITHUB_STEP_SUMMARY}"
          echo "### Updated Extensions (${UPDATED_COUNT})" >> "${GITHUB_STEP_SUMMARY}"
          if [[ "${UPDATED_COUNT}" -eq 0 ]]; then
            echo "No extensions were updated." >> "${GITHUB_STEP_SUMMARY}"
          else
            echo "<details><summary>Show updated extensions</summary>" >> "${GITHUB_STEP_SUMMARY}"
            echo "" >> "${GITHUB_STEP_SUMMARY}"
            IFS=',' read -ra EXTENSIONS <<< "${UPDATED_EXTENSIONS}"
            for ext in "${EXTENSIONS[@]}"; do
              [[ -n "${ext}" ]] && echo "- ${ext}" >> "${GITHUB_STEP_SUMMARY}"
            done
            echo "" >> "${GITHUB_STEP_SUMMARY}"
            echo "</details>" >> "${GITHUB_STEP_SUMMARY}"
          fi

          echo "" >> "${GITHUB_STEP_SUMMARY}"
          echo "### Skipped Extensions (${SKIPPED_COUNT})" >> "${GITHUB_STEP_SUMMARY}"
          if [[ "${SKIPPED_COUNT}" -eq 0 ]]; then
            echo "No extensions were skipped." >> "${GITHUB_STEP_SUMMARY}"
          else
            echo "<details><summary>Show skipped extensions</summary>" >> "${GITHUB_STEP_SUMMARY}"
            echo "" >> "${GITHUB_STEP_SUMMARY}"
            IFS=',' read -ra EXTENSIONS <<< "${SKIPPED_EXTENSIONS}"
            for ext in "${EXTENSIONS[@]}"; do
              [[ -n "${ext}" ]] && echo "- ${ext}" >> "${GITHUB_STEP_SUMMARY}"
            done
            echo "" >> "${GITHUB_STEP_SUMMARY}"
            echo "</details>" >> "${GITHUB_STEP_SUMMARY}"
          fi

          echo "" >> "${GITHUB_STEP_SUMMARY}"
          echo "### Renamed Extensions (Auto-Fixed) (${RENAMED_COUNT})" >> "${GITHUB_STEP_SUMMARY}"
          if [[ "${RENAMED_COUNT}" -eq 0 ]]; then
            echo "No extensions were renamed." >> "${GITHUB_STEP_SUMMARY}"
          else
            echo "<details><summary>Show renamed extensions</summary>" >> "${GITHUB_STEP_SUMMARY}"
            echo "" >> "${GITHUB_STEP_SUMMARY}"
            IFS=',' read -ra EXTENSIONS <<< "${RENAMED_EXTENSIONS}"
            for ext in "${EXTENSIONS[@]}"; do
              [[ -n "${ext}" ]] && echo "- ${ext}" >> "${GITHUB_STEP_SUMMARY}"
            done
            echo "" >> "${GITHUB_STEP_SUMMARY}"
            echo "</details>" >> "${GITHUB_STEP_SUMMARY}"
          fi

          echo "" >> "${GITHUB_STEP_SUMMARY}"
          echo "### Outdated Extensions (${OUTDATED_COUNT})" >> "${GITHUB_STEP_SUMMARY}"
          if [[ "${OUTDATED_COUNT}" -eq 0 ]]; then
            echo "No extensions were outdated." >> "${GITHUB_STEP_SUMMARY}"
          else
            echo "<details><summary>Show outdated extensions</summary>" >> "${GITHUB_STEP_SUMMARY}"
            echo "" >> "${GITHUB_STEP_SUMMARY}"
            IFS=',' read -ra EXTENSIONS <<< "${OUTDATED_EXTENSIONS}"
            for ext in "${EXTENSIONS[@]}"; do
              [[ -n "${ext}" ]] && echo "- ${ext}" >> "${GITHUB_STEP_SUMMARY}"
            done
            echo "" >> "${GITHUB_STEP_SUMMARY}"
            echo "</details>" >> "${GITHUB_STEP_SUMMARY}"
          fi
